<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Change Story Image - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../style.css" />
  <style>
    .edit-form {
      max-width: 600px;
      margin: 2rem auto;
      background: #fff0f5;
      padding: 1.5rem;
      border-radius: 20px;
      font-family: 'Comic Sans MS', cursive;
    }
    .edit-form h2 {
      text-align: center;
      color: #a14d86;
    }
    .edit-form label {
      font-weight: bold;
      display: block;
      margin-top: 1rem;
    }
    /* Style for the file input */
    .edit-form input[type="file"] {
      width: 100%;
      padding: 10px;
      border: 1px dashed #ddd;
      border-radius: 10px;
      margin-top: 5px;
      font-family: inherit;
      background-color: #fff;
    }
    .edit-form button {
      background-color: #ff70a6;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      font-family: inherit;
      margin-top: 1.5rem;
      cursor: pointer;
      width: 100%;
    }
    .edit-form button:hover {
      background-color: #ff4d8b;
    }
    #previewImage {
      display: block;
      margin: 1rem auto 0;
      max-width: 100%;
      max-height: 300px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <div class="edit-form">
    <h2>üñºÔ∏è Change Story Image</h2>
    <form id="editImageForm" enctype="multipart/form-data">
      <label>Current Image:</label>
      <img id="previewImage" src="" alt="Story Image Preview" />
      
      <label for="newImageFile" style="margin-top: 1.5rem;">Choose a new image:</label>
      <input type="file" id="newImageFile" name="storyImage" accept="image/*" required />
      
      <button type="submit">Upload New Image</button>
    </form>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const storyId = params.get('id');
    const form = document.getElementById("editImageForm");
    const imageInput = document.getElementById("newImageFile");
    const preview = document.getElementById("previewImage");

    if (!storyId) {
      alert("Missing story ID");
      window.location.href = "list.html";
    }

    // Load the current image
    async function loadCurrentImage() {
      try {
        const res = await fetch(`/stories/${storyId}`);
        if (!res.ok) throw new Error("Story not found");
        const story = await res.json();
        preview.src = story.image || "/assets/default.png";
      } catch (err) {
        alert("Error loading current image.");
        window.location.href = "list.html";
      }
    }
    
    // Show a preview of the new image when selected
    imageInput.addEventListener("change", () => {
        const file = imageInput.files[0];
        if (file) {
            preview.src = URL.createObjectURL(file);
        }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      // We need to use FormData to send a file
      const formData = new FormData();
      formData.append('storyImage', imageInput.files[0]);

      try {
        const res = await fetch(`/stories/update-image/${storyId}`, {
          method: "POST", // Use POST for file uploads, not PUT
          body: formData, // No headers needed, browser sets it
        });

        if (res.ok) {
          alert("Image updated successfully!");
          window.location.href = "list.html";
        } else {
          const error = await res.json();
          alert(`Failed to update image: ${error.message}`);
        }
      } catch (err) {
        alert("An error occurred during upload.");
      }
    });

    loadCurrentImage();
  </script>
</body>
</html>